--// Refactored & Bug-Fixed ESP Instance Class
local ESPInstance = {}
ESPInstance.__index = ESPInstance

function ESPInstance.new(player)
    local self = setmetatable({}, ESPInstance)
    self.Player = player
    self.Components = {
        Box = CreateDrawing("Square", {Thickness = 1, Filled = false, ZIndex = 2}),
        BoxOutline = CreateDrawing("Square", {Thickness = 3, Color = Color3.new(0,0,0), Filled = false, ZIndex = 1}),
        Name = CreateDrawing("Text", {Size = 13, Center = true, Outline = true, ZIndex = 2}),
        Distance = CreateDrawing("Text", {Size = 12, Center = true, Outline = true, ZIndex = 2}),
        Tracer = CreateDrawing("Line", {Thickness = 1, Transparency = 1, ZIndex = 2}),
        HealthBar = CreateDrawing("Line", {Thickness = 1, ZIndex = 2}),
        HealthOutline = CreateDrawing("Line", {Thickness = 3, Color = Color3.new(0,0,0), ZIndex = 1}),
        SkeletonLines = {}, -- Only Drawing objects go here now
        CornerLines = {}    -- Only Drawing objects go here now
    }
    return self
end

function ESPInstance:Update()
    local player = self.Player
    local char = player.Character
    local components = self.Components
    
    -- Safety Helper: Only sets Visibility on actual Drawing objects
    local function setVisibility(obj, state)
        if typeof(obj) == "table" then
            for _, child in pairs(obj) do
                if typeof(child) == "userdata" then
                    child.Visible = state
                end
            end
        elseif typeof(obj) == "userdata" then
            obj.Visible = state
        end
    end

    local function setAllVisible(state)
        for _, comp in pairs(components) do
            setVisibility(comp, state)
        end
    end

    -- 1. Check if ESP is enabled/valid
    if not ESP.Enabled or not char or (ESP.TeamCheck and player.Team == localPlayer.Team) then
        setAllVisible(false)
        return
    end

    -- 2. Check Humanoid and Health
    local hum = char:FindFirstChildOfClass("Humanoid")
    local root = char:FindFirstChild("HumanoidRootPart")
    if not root or not hum or (ESP.AliveCheck and hum.Health <= 0) then
        setAllVisible(false)
        return
    end

    -- 3. On-Screen and Wall Check
    local pos, onScreen = camera:WorldToViewportPoint(root.Position)
    if not onScreen or not IsVisible(player, char) then
        setAllVisible(false)
        return
    end

    -- 4. Ghost Check
    if ESP.GhostCheck then
        local head = char:FindFirstChild("Head")
        if head and head.Transparency > 0.8 then
            setAllVisible(false)
            return
        end
    end

    -- Calculate screen bounds
    local head = char:FindFirstChild("Head")
    local headPos = camera:WorldToViewportPoint(head and (head.Position + Vector3.new(0, 0.5, 0)) or (root.Position + Vector3.new(0, 3, 0)))
    local legPos = camera:WorldToViewportPoint(root.Position - Vector3.new(0, 3, 0))
    
    local height = math.abs(headPos.Y - legPos.Y)
    local width = height * 0.6
    local size = Vector2.new(width, height)
    local position = Vector2.new(pos.X - width/2, pos.Y - height/2)

    -- Box Logic
    if ESP.Settings.ShowBox then
        if ESP.Settings.BoxType == "2D" then
            components.Box.Visible = true
            components.BoxOutline.Visible = true
            components.Box.Size = size
            components.Box.Position = position
            components.Box.Color = ESP.Settings.BoxColor
            components.BoxOutline.Size = size
            components.BoxOutline.Position = position
            setVisibility(components.CornerLines, false)
        else
            components.Box.Visible = false
            components.BoxOutline.Visible = false
            self:UpdateCorners(position, size)
        end
    else
        components.Box.Visible = false
        components.BoxOutline.Visible = false
        setVisibility(components.CornerLines, false)
    end

    -- Name & Distance
    if ESP.Settings.ShowName then
        components.Name.Visible = true
        components.Name.Text = player.Name:lower()
        components.Name.Position = Vector2.new(pos.X, position.Y - 16)
        components.Name.Color = ESP.Settings.NameColor
    else components.Name.Visible = false end

    if ESP.Settings.ShowDistance then
        components.Distance.Visible = true
        components.Distance.Text = math.floor((camera.CFrame.Position - root.Position).Magnitude) .. " studs"
        components.Distance.Position = Vector2.new(pos.X, position.Y + height + 2)
    else components.Distance.Visible = false end

    -- Health
    if ESP.Settings.ShowHealth then
        local healthPct = math.clamp(hum.Health / hum.MaxHealth, 0, 1)
        components.HealthOutline.Visible = true
        components.HealthOutline.From = Vector2.new(position.X - 5, position.Y + height)
        components.HealthOutline.To = Vector2.new(position.X - 5, position.Y)
        
        components.HealthBar.Visible = true
        components.HealthBar.From = Vector2.new(position.X - 5, position.Y + height)
        components.HealthBar.To = Vector2.new(position.X - 5, position.Y + height - (height * healthPct))
        components.HealthBar.Color = ESP.Settings.HealthLowColor:Lerp(ESP.Settings.HealthHighColor, healthPct)
    else
        components.HealthBar.Visible = false
        components.HealthOutline.Visible = false
    end

    -- Tracer
    if ESP.Settings.ShowTracer then
        local targetY = (ESP.Settings.TracerPosition == "Top" and 0) or (ESP.Settings.TracerPosition == "Middle" and camera.ViewportSize.Y / 2) or camera.ViewportSize.Y
        components.Tracer.Visible = true
        components.Tracer.From = Vector2.new(camera.ViewportSize.X / 2, targetY)
        components.Tracer.To = Vector2.new(pos.X, pos.Y)
    else components.Tracer.Visible = false end

    -- Skeleton
    if ESP.Settings.ShowSkeletons then
        self:UpdateSkeleton(char)
    else
        setVisibility(components.SkeletonLines, false)
    end
end

function ESPInstance:Destroy()
    for _, comp in pairs(self.Components) do
        if typeof(comp) == "table" then
            for _, obj in pairs(comp) do 
                if typeof(obj) == "userdata" then obj:Remove() end 
            end
        elseif typeof(comp) == "userdata" then
            comp:Remove()
        end
    end
    self.Components = nil
end
